<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>전체 톡방</title>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>

<style>
/* Reset and base styles */
html, body {
  height: 100%; /* 전체 화면 높이 사용 */
  margin: 0;
  overflow: hidden; /* body 스크롤 방지 */
  font-family: sans-serif;
  color: white;
  background: #0f172a;
  -webkit-text-size-adjust: 100%;
}

.app {
  display: flex;
  flex-direction: column; /* 자식 요소들을 세로로 배치 */
  height: 100%; /* 부모(body) 높이에 맞춤 */
  width: 100%;
  max-width: 980px; /* 데스크톱에서 최대 너비 */
  margin: 0 auto; /* 데스크톱에서 가운데 정렬 */
  background: #020617;
  border-radius: 12px; /* 데스크톱 모드 라운드 처리 */
  box-shadow: 0 0 25px rgba(0,0,0,0.6);
  box-sizing: border-box;
  font-size: 1.2rem;
}

/* Header and Footer styles */
.chat-header, .chat-footer {
  flex-shrink: 0; /* 내용이 많아져도 크기가 줄어들지 않도록 고정 */
  padding: 20px 25px; /* 내부 여백 */
  background: #020617; /* 앱 배경과 동일하게 */
  border-bottom: 1px solid #1e293b; /* 헤더 구분선 */
}
.chat-footer {
  border-top: 1px solid #1e293b; /* 푸터 구분선 */
  border-bottom: none;
  padding-top: 15px;
  padding-bottom: 20px;
}

/* Input and Button styles */
input, button {
  width: 100%; /* 부모 컨테이너의 패딩을 제외한 영역을 꽉 채움 */
  padding: 16px;
  border-radius: 10px;
  border: 1px solid #1e293b;
  background-color: #0f172a;
  color: white;
  font-size: 1.1rem;
  box-sizing: border-box;
  min-height: 52px;
}
input#name { /* 이름 입력창 스타일 */
    margin-bottom: 0; /* 헤더 내에서 하단 마진 제거 */
}
input#text { /* 메시지 입력창 스타일 */
    margin-top: 0; /* 푸터 내에서 상단 마진 제거 */
    margin-bottom: 12px; /* 버튼과의 간격 */
}
input::placeholder {
    color: #94a3b8;
}
button {
  background: #38bdf8;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.2s;
  font-size: 1.2rem;
  margin-top: 0; /* 푸터 내에서 상단 마진 제거 */
}
button:hover {
  background: #0ea5e9;
}

/* Messages area */
#messages {
  flex-grow: 1; /* 남은 공간을 모두 차지하여 스크롤 가능하게 함 */
  overflow-y: auto; /* 메시지가 넘치면 스크롤 */
  padding: 15px 25px; /* 내부 패딩 */
  word-wrap: break-word;
  line-height: 1.6;
  font-size: 1.1rem;

  /* 메시지가 아래에서 위로 쌓이게 하는 설정 */
  display: flex;
  flex-direction: column-reverse;
  justify-content: flex-start;
}

/* Individual message style */
.msg {
  margin-top: 10px; /* 메시지 간격 조정 (column-reverse이므로 margin-top) */
  padding: 8px 10px;
  cursor: pointer;
  border-radius: 8px;
  transition: background-color 0.1s ease;
  flex-shrink: 0;
  background-color: #2d3748;
}
.msg:first-child { /* 가장 아래 메시지(column-reverse 기준 첫 번째) 위쪽 마진 제거 */
  margin-top: 0;
}
.msg:hover {
  background-color: #3f4d62;
}
.my-message {
  font-weight: bold;
  color: #a7f3d0;
  background-color: #1a4d33;
  text-align: right;
  margin-left: auto;
  max-width: 85%;
  border-bottom-right-radius: 0;
}
.my-message b {
  color: #a7f3d0;
}
.msg b {
  color: #38bdf8;
}

/* Mobile optimization (smartphones portrait mode) */
@media (max-width: 768px) {
  .app {
    border-radius: 0; /* 모바일에서는 모서리 라운드 제거 */
    max-width: 100%; /* 모바일에서는 너비 꽉 채움 */
  }
  .chat-header, .chat-footer, #messages {
    padding-left: 20px; /* 모바일에서 패딩 조정 */
    padding-right: 20px;
  }
  .chat-header {
      padding-top: 15px;
      padding-bottom: 10px;
  }
  .chat-footer {
      padding-top: 10px;
      padding-bottom: 15px;
  }
  input, button {
    font-size: 1.15rem;
    padding: 15px;
    min-height: 50px;
    border-radius: 8px;
  }
  button {
    font-size: 1.25rem;
  }
}
</style>
</head>

<body>
<div class="app">
  <header class="chat-header">
    <input id="name" placeholder="이름을 입력하세요">
  </header>

  <div id="messages"></div>

  <footer class="chat-footer">
    <input id="text" placeholder="메시지를 입력하세요">
    <button onclick="send()">전송</button>
  </footer>
</div>

<script>
  // Firebase 설정 (기존과 동일)
  const firebaseConfig = {
    apiKey: "AIzaSyDGhqeGmPS_0Yvl5cef_I6N8wCogbv__to",
    authDomain: "globe007.firebaseapp.com",
    projectId: "globe007",
    storageBucket: "globe007.firebasestorage.app",
    messagingSenderId: "518758558092",
    appId: "1:518758558092:web:0393c788a78974bc21cea9"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const messagesDiv = document.getElementById("messages");
  const nameInput = document.getElementById("name");
  const textInput = document.getElementById("text");

  let clientId = localStorage.getItem('chatClientId');
  if (!clientId) {
    clientId = uuid.v4(); // UUID 라이브러리를 사용하여 고유 ID 생성
    localStorage.setItem('chatClientId', clientId);
  }

  let storedName = localStorage.getItem('chatName');
  if (storedName) {
    nameInput.value = storedName;
  }

  db.collection("messages")
    .orderBy("time", "asc") // 모든 메시지를 오래된 것부터 가져오기
    .onSnapshot(snapshot => {
      // 스크롤이 가장 아래(최신 메시지)에 가까운지 확인 (column-reverse이므로 scrollTop이 0에 가까우면 가장 아래)
      const isScrolledToBottom = messagesDiv.scrollTop < 20;

      const oldScrollHeight = messagesDiv.scrollHeight;
      const oldScrollTop = messagesDiv.scrollTop;

      messagesDiv.innerHTML = "";

      snapshot.docs.reverse().forEach(doc => {
        const m = doc.data();
        const docId = doc.id;
        let messageHtml = `<div class="msg" data-docid="${docId}" data-clientid="${m.clientId}"><b>${m.name}</b>: ${m.text}</div>`;

        if (m.clientId === clientId) {
          messageHtml = `<div class="msg my-message" data-docid="${docId}" data-clientid="${m.clientId}"><b>${m.name}</b>: ${m.text}</div>`;
        }
        messagesDiv.innerHTML += messageHtml;
      });

      const newScrollHeight = messagesDiv.scrollHeight;

      // 스크롤이 이전에 가장 아래에 있었다면 새 메시지 추가 후에도 가장 아래로 이동
      if (isScrolledToBottom) {
        messagesDiv.scrollTop = 0;
      } else {
        // 아니면 이전 스크롤 위치 유지 (새 메시지로 인해 스크롤 위치가 밀린 만큼 조정)
        messagesDiv.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);
      }

      messagesDiv.querySelectorAll('.msg').forEach(messageElement => {
        messageElement.onclick = function() {
          const messageClientId = this.getAttribute('data-clientid');
          const messageDocId = this.getAttribute('data-docid');

          if (messageClientId === clientId) {
            if (confirm("정말로 이 메시지를 삭제하시겠습니까?")) {
              db.collection("messages").doc(messageDocId).delete()
                .then(() => {
                  console.log("메시지가 성공적으로 삭제되었습니다.");
                })
                .catch((error) => {
                  console.error("메시지 삭제 중 오류 발생:", error);
                  alert("메시지 삭제 중 오류가 발생했습니다.");
                });
            }
          } else {
            console.log("본인 메시지만 삭제할 수 있습니다.");
          }
        };
      });
    });

  function send() {
    const name = nameInput.value.trim();
    let messageText = textInput.value.trim(); // 메시지 내용을 여기에 저장

    if (!name || !messageText) {
        alert("이름과 메시지를 모두 입력해주세요.");
        return;
    }

    localStorage.setItem('chatName', name);

    // '/t' 명령어 처리
    if (messageText === "/t") {
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0'); // 월은 0부터 시작하므로 +1
        const day = now.getDate().toString().padStart(2, '0');
        let hours = now.getHours();
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const ampm = hours >= 12 ? '오후' : '오전';
        hours = hours % 12;
        hours = hours ? hours : 12; // 0시는 12시로 표시

        messageText = `${year}.${month}.${day} ${ampm} ${hours}시 ${minutes}분`;
    }

    db.collection("messages").add({
      name,
      text: messageText, // 처리된 메시지 내용을 Firestore에 저장
      time: firebase.firestore.FieldValue.serverTimestamp(),
      clientId: clientId
    });

    textInput.value = ""; // 메시지 입력창 비우기
  }
</script>
</body>
</html>
